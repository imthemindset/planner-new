<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejador Financeiro</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome CDN for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        .hidden { display: none; }
        .chart-container {
            width: 100%;
            max-width: 600px;
            height: 350px;
            max-height: 400px;
            position: relative;
            margin: 0 auto;
            overflow: hidden;
        }
        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
    <script type="module">
        // Firebase Import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCdLPPg0DNm99j5sL02QGONqa_LQZ4Ns7M",
            authDomain: "financial-planner-e90e2.firebaseapp.com",
            projectId: "financial-planner-e90e2",
            storageBucket: "financial-planner-e90e2.firebasestorage.app",
            messagingSenderId: "313457678965",
            appId: "1:313457678965:web:3d2059b93cc7cabf59f63c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Categories
        const categories = {
            expense: ['Moradia', 'Alimentação', 'Transporte', 'Saúde', 'Lazer', 'Educação', 'Outros'],
            income: ['Salário', 'Freelance', 'Investimentos', 'Outros']
        };

        // Data
        let transactions = [];
        let goals = [];
        let isLoggedIn = false;
        let selectedYear = 2025;
        let filters = { year: '', month: '', category: '', type: '', search: '' };

        // Firebase Listeners
        onValue(ref(db, 'transactions'), snapshot => {
            transactions = snapshot.val() ? Object.values(snapshot.val()) : [];
            updateUI();
        });

        onValue(ref(db, 'goals'), snapshot => {
            goals = snapshot.val() ? Object.values(snapshot.val()) : [];
            updateUI();
        });

        // Login
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim().toLowerCase();
            const password = document.getElementById('login-password').value.trim();
            const errorDiv = document.getElementById('login-error');
            const errorSpan = errorDiv.querySelector('span');

            if (!email || !password) {
                errorDiv.classList.remove('hidden');
                errorSpan.textContent = 'Por favor, preencha todos os campos';
                return;
            }

            const validEmail = atob('bmV0b3phZWxAZ21haWwuY29t');
            const validPassword = atob('bmV0bzEyMzc0');

            if (email === validEmail && password === validPassword) {
                isLoggedIn = true;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                updateUI();
            } else {
                errorDiv.classList.remove('hidden');
                errorSpan.textContent = 'Email ou senha incorretos. Acesso negado.';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            isLoggedIn = false;
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('login-form').reset();
            document.getElementById('login-error').classList.add('hidden');
        });

        // Tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg'));
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-50'));
                btn.classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-50');
                btn.classList.add('bg-indigo-600', 'text-white', 'shadow-lg');
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(btn.dataset.tab).classList.remove('hidden');
                if (btn.dataset.tab === 'overview' || btn.dataset.tab === 'categories') updateCharts();
            });
        });

        // Populate Categories
        function updateCategories() {
            const typeSelect = document.getElementById('new-transaction-type');
            const categorySelect = document.getElementById('new-transaction-category');
            const filterCategorySelect = document.getElementById('filter-category');
            categorySelect.innerHTML = categories[typeSelect.value].map(cat => `<option value="${cat}">${cat}</option>`).join('');
            filterCategorySelect.innerHTML = '<option value="">Todas</option>' +
                [...new Set([...categories.expense, ...categories.income])].map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }
        document.getElementById('new-transaction-type').addEventListener('change', updateCategories);
        updateCategories();

        // Populate Years
        const yearSelect = document.getElementById('year-select');
        const filterYearSelect = document.getElementById('filter-year');
        function updateYears() {
            const years = [...new Set(transactions.map(t => new Date(t.date).getFullYear()))];
            const allYears = [2025, 2026, 2027, 2028, 2029, 2030];
            years.forEach(year => { if (!allYears.includes(year)) allYears.push(year); });
            allYears.sort();
            yearSelect.innerHTML = allYears.map(year => `<option value="${year}">${year}</option>`).join('');
            filterYearSelect.innerHTML = '<option value="">Todos</option>' + allYears.map(year => `<option value="${year}">${year}</option>`).join('');
            yearSelect.value = selectedYear;
        }
        yearSelect.addEventListener('change', () => {
            selectedYear = parseInt(yearSelect.value);
            updateUI();
        });

        // Add Transaction
        document.getElementById('add-transaction-btn').addEventListener('click', () => {
            const transaction = {
                id: Date.now(),
                date: document.getElementById('new-transaction-date').value,
                type: document.getElementById('new-transaction-type').value,
                category: document.getElementById('new-transaction-category').value,
                amount: parseFloat(document.getElementById('new-transaction-amount').value),
                description: document.getElementById('new-transaction-description').value
            };
            if (transaction.date && transaction.amount && transaction.description) {
                const newRef = push(ref(db, 'transactions'));
                set(newRef, transaction);
                document.getElementById('new-transaction-date').value = '';
                document.getElementById('new-transaction-type').value = 'expense';
                document.getElementById('new-transaction-category').value = 'Moradia';
                document.getElementById('new-transaction-amount').value = '';
                document.getElementById('new-transaction-description').value = '';
                updateCategories();
                updateYears();
            }
        });

        // Add Goal
        document.getElementById('add-goal-btn').addEventListener('click', () => {
            const goal = {
                id: Date.now(),
                name: document.getElementById('new-goal-name').value,
                target: parseFloat(document.getElementById('new-goal-target').value),
                current: parseFloat(document.getElementById('new-goal-current').value),
                deadline: document.getElementById('new-goal-deadline').value
            };
            if (goal.name && goal.target && goal.current !== '' && goal.deadline) {
                const newRef = push(ref(db, 'goals'));
                set(newRef, goal);
                document.getElementById('new-goal-name').value = '';
                document.getElementById('new-goal-target').value = '';
                document.getElementById('new-goal-current').value = '';
                document.getElementById('new-goal-deadline').value = '';
            }
        });

        // Filters
        function getFilteredTransactions() {
            return transactions.filter(t => {
                const tDate = new Date(t.date);
                const tYear = tDate.getFullYear();
                const tMonth = tDate.getMonth();
                if (filters.year && tYear !== parseInt(filters.year)) return false;
                if (filters.month !== '' && tMonth !== parseInt(filters.month)) return false;
                if (filters.category && t.category !== filters.category) return false;
                if (filters.type && t.type !== filters.type) return false;
                if (filters.search && !t.description.toLowerCase().includes(filters.search.toLowerCase())) return false;
                return true;
            });
        }

        ['year', 'month', 'type', 'category'].forEach(f => {
            document.getElementById(`filter-${f}`).addEventListener('change', e => { filters[f] = e.target.value; updateUI(); });
        });
        document.getElementById('filter-search').addEventListener('input', e => { filters.search = e.target.value; updateUI(); });

        // Charts & UI (mantido igual ao seu original)
        let cashflowChart, monthlyChart, categoryChart;
        function updateCharts() {
            const monthlyData = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'].map((month,index)=>{
                const monthTransactions = transactions.filter(t=>new Date(t.date).getFullYear()===selectedYear&&new Date(t.date).getMonth()===index);
                const income = monthTransactions.filter(t=>t.type==='income').reduce((sum,t)=>sum+t.amount,0);
                const expenses = monthTransactions.filter(t=>t.type==='expense').reduce((sum,t)=>sum+t.amount,0);
                return {month,income,expenses,savings:income-expenses};
            });

            const categoryData=(()=>{
                const yearTransactions=transactions.filter(t=>new Date(t.date).getFullYear()===selectedYear&&t.type==='expense');
                const categoryTotals={};
                yearTransactions.forEach(t=>categoryTotals[t.category]=(categoryTotals[t.category]||0)+t.amount);
                const colors=['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#6b7280'];
                return Object.entries(categoryTotals).map(([name,value],index)=>({name,value,color:colors[index%colors.length]}));
            })();

            if(cashflowChart) cashflowChart.destroy();
            cashflowChart=new Chart(document.getElementById('cashflow-chart'),{type:'line',data:{labels:monthlyData.map(d=>d.month),datasets:[{label:'Receita',data:monthlyData.map(d=>d.income),borderColor:'#10b981',fill:false},{label:'Despesas',data:monthlyData.map(d=>d.expenses),borderColor:'#ef4444',fill:false},{label:'Economia',data:monthlyData.map(d=>d.savings),borderColor:'#3b82f6',fill:false}]},options:{responsive:true,maintainAspectRatio:false}});
            
            if(monthlyChart) monthlyChart.destroy();
            monthlyChart=new Chart(document.getElementById('monthly-chart'),{type:'bar',data:{labels:monthlyData.map(d=>d.month),datasets:[{label:'Receita',data:monthlyData.map(d=>d.income),backgroundColor:'#10b981'},{label:'Despesas',data:monthlyData.map(d=>d.expenses),backgroundColor:'#ef4444'}]},options:{responsive:true,maintainAspectRatio:false}});
            
            if(categoryChart) categoryChart.destroy();
            categoryChart=new Chart(document.getElementById('category-chart'),{type:'pie',data:{labels:categoryData.map(d=>d.name),datasets:[{data:categoryData.map(d=>d.value),backgroundColor:categoryData.map(d=>d.color)}]},options:{responsive:true,maintainAspectRatio:false}});
            
            const categoryDetails=document.getElementById('category-details');
            categoryDetails.innerHTML=categoryData.map(cat=>`<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><div class="flex items-center gap-3"><div class="w-4 h-4 rounded-full" style="background-color: ${cat.color}"></div><span class="font-semibold text-gray-700">${cat.name}</span></div><div class="text-right"><p class="font-bold text-gray-800">R$ ${cat.value.toLocaleString('pt-BR')}</p><p class="text-sm text-gray-500">${((cat.value/categoryData.reduce((sum,c)=>sum+c.value,0))*100).toFixed(1)}%</p></div></div>`).join('');
        }

        function updateUI() {
            if(!isLoggedIn){document.getElementById('login-screen').classList.remove('hidden');document.getElementById('dashboard').classList.add('hidden');return;}
            const yearTransactions=transactions.filter(t=>new Date(t.date).getFullYear()===selectedYear);
            const totalIncome=yearTransactions.filter(t=>t.type==='income').reduce((sum,t)=>sum+t.amount,0);
            const totalExpenses=yearTransactions.filter(t=>t.type==='expense').reduce((sum,t)=>sum+t.amount,0);
            const totalSavings=totalIncome-totalExpenses;
            const savingsRate=totalIncome>0?(totalSavings/totalIncome)*100:0;

            document.getElementById('total-income').textContent=`R$ ${totalIncome.toLocaleString('pt-BR')}`;
            document.getElementById('total-expenses').textContent=`R$ ${totalExpenses.toLocaleString('pt-BR')}`;
            document.getElementById('total-savings').textContent=`R$ ${totalSavings.toLocaleString('pt-BR')}`;
            document.getElementById('savings-rate').textContent=`${savingsRate.toFixed(1)}%`;
            document.getElementById('analysis-savings-rate').textContent=`${savingsRate.toFixed(1)}%`;
            document.getElementById('analysis-savings-rate').className=`font-bold ${savingsRate>20?'text-green-600':'text-yellow-600'}`;
            document.getElementById('recommendation').textContent=savingsRate<20?'Considere aumentar sua taxa de poupança para pelo menos 20%':'Excelente taxa de poupança! Continue assim';

            const filteredTransactions=getFilteredTransactions();
            document.getElementById('transaction-count').textContent=filteredTransactions.length;
            const tbody=document.getElementById('transaction-table');
            tbody.innerHTML=filteredTransactions.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t=>`<tr><td class="px-4 py-3 text-sm">${t.date}</td><td class="px-4 py-3 text-sm">${t.type==='income'?'Receita':'Despesa'}</td><td class="px-4 py-3 text-sm">${t.category}</td><td class="px-4 py-3 text-sm">${t.description}</td><td class="px-4 py-3 text-sm text-right">R$ ${t.amount.toLocaleString('pt-BR')}</td><td class="px-4 py-3 text-center"><button class="text-red-600 hover:text-red-800" onclick="deleteTransaction(${t.id})"><i class="fas fa-trash"></i></button></td></tr>`).join('');
            document.getElementById('no-transactions').classList.toggle('hidden',filteredTransactions.length>0);

            // Goals
            const goalsList=document.getElementById('goals-list');
            goalsList.innerHTML=goals.map(g=>`<div class="p-4 bg-gray-50 rounded-lg shadow flex justify-between items-center"><div><p class="font-semibold text-gray-700">${g.name}</p><p class="text-sm text-gray-600">R$ ${g.current.toLocaleString('pt-BR')} / R$ ${g.target.toLocaleString('pt-BR')}</p></div><p class="font-bold text-indigo-600">${((g.current/g.target)*100).toFixed(1)}%</p></div>`).join('');
            document.getElementById('no-goals').classList.toggle('hidden',goals.length>0);

            updateCharts();
        }

        // Delete Transaction
        window.deleteTransaction = function(id){
            const txRef = ref(db,'transactions');
            onValue(txRef, snapshot => {
                snapshot.forEach(childSnap => {
                    if(childSnap.val().id === id) set(ref(db,'transactions/'+childSnap.key), null);
                });
            }, {onlyOnce:true});
        }
    </script>
</body>
</html>
